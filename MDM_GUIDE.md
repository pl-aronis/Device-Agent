# Apple MDM Server - User Guide

This guide details how to set up, enroll, and manage macOS devices using your custom MDM server, utilizing **completely free** Apple services.

## üí∞ Cost Breakdown

| Item | Cost | Explanation |
| :--- | :--- | :--- |
| **Apple Business Manager** | **$0 (Free)** | The account and service itself are free for authorized businesses. |
| **MDM Push Certificate** | **$0 (Community)** | Technically requires a $299 Enterprise account, but you can use [mdmcert.download](https://mdmcert.download) to sign your CSR for free. |
| **Server Software** | **$0 (Free)** | This project is an open-source/custom implementation, so there are no software licensing fees. |
| **Hosting** | **$0 / Varies** | Free for local testing (e.g., free tier of ngrok). Production hosting depends on your provider (e.g., AWS Free Tier, DigitalOcean droplet ~$5/mo). |
| **Profile Signing Cert** | **$0 (Optional)** | You can use a self-signed certificate (device will show "Unverified Profile" but still work). To remove the warning, you need a paid Apple Developer account ($99/yr) or a trusted SSL cert. |

**Total Essential Cost: $0.00**

---

## 1. Prerequisites (What you need)

*   **Apple ID** (Free, for certificates)
*   **Public HTTPS URL** (Using ngrok for free testing)
*   **A macOS Device** (Virtual Machine recommended for testing)

---

## 2. Get Free Certificates

**Crucial Note**: To get an APNs certificate, your CSR must be signed by an MDM Vendor. Since you don't have an Enterprise Account ($299), you must use a community service.

1.  **Generate a CSR**:
    ```bash
    openssl req -new -key key.pem -out request.csr
    ```
2.  **Sign the CSR**:
    *   Visit [mdmcert.download](https://mdmcert.download) (or a similar community signing service).
    *   Upload your `request.csr`.
    *   Download the **signed** `.plist` or `.csr` file it generates.
3.  **Go to Apple Portal**: Visit [identity.apple.com/pushcert](https://identity.apple.com/pushcert).
4.  **Upload & Download**: Upload the **signed** file from step 2 and download the `.pem` file.
5.  **Convert to P12**:
    ```bash
    openssl pkcs12 -export -in mdm_push_cert.pem -inkey key.pem -out mdm-server/certs/push.p12
    ```

---

## 3. Server Configuration

1.  **Edit `mdm-server/cmd/mdmserver/main.go`**:
    *   Update `apns.NewClient` with your `.p12` password and the Topic (UID) from your cert.
2.  **Edit `mdm-server/profiles/enrollment.mobileconfig`**:
    *   Replace `REPLACE_WITH_YOUR_HOST` with your public ngrok URL.
    *   Replace `REPLACE_WITH_UUID` with your specific Push Topic (from the cert).

---

## 4. Run the Server

1.  **Start MDM Server**:
    ```bash
    cd mdm-server
    go run cmd/mdmserver/main.go
    ```
2.  **Expose to Internet** (in a separate terminal):
    ```bash
    ngrok http 8080
    ```
    *Copy the HTTPS URL generated by ngrok.*

---

## 5. Enroll a macOS Device

1.  **Open Safari** on the Mac you want to manage.
2.  **Visit**: `https://<your-ngrok-url>/mdm/enroll` (or point directly to the .mobileconfig file).
3.  **Download Profile**: Click "Allow" when prompted.
4.  **Install Profile**:
    *   Go to **System Settings** > **Privacy & Security** > **Profiles**.
    *   Find "Custom Device Agent Enrollment".
    *   Double-click and select **Install**.
    *   Enter your Mac's admin password.

Once installed, the device is **Enrolled**!

---

## 6. Managing the Device

Check the `mdm-server` console logs to see the device UDID checking in. Use that UDID for commands.

### üîí Lock Device
Locks the screen immediately. Requires a 6-digit PIN to unlock.
```bash
curl -X POST "http://localhost:8080/api/devices/<UDID>/lock"
```

### üìç Locate Device (Lost Mode)
Puts device in Lost Mode (lock screen with message) and reports location.
```bash
curl -X POST "http://localhost:8080/api/devices/<UDID>/lostmode"
```
*Wait ~30 seconds, then check logs for location coordinates.*

### üîì Unlock (Disable Lost Mode)
Removes Lost Mode and unlocks the device.
```bash
curl -X POST "http://localhost:8080/api/devices/<UDID>/disabledlostmode"
```

### üßπ Wipe Device (Factory Reset)
**WARNING: Destructive!** Erases all data and resets macOS.
```bash
curl -X POST "http://localhost:8080/api/devices/<UDID>/wipe"
```

---

## 7. Troubleshooting

*   **"Profile Installation Failed"**: Ensure your server is reachable via HTTPS and the certificate topic matches exactly.
*   **Commands not arriving**: Check `mdm-server` logs. If "Push sent" is successful but device doesn't react, check internet connection or firewalls blocking port 5223 (APNs).
